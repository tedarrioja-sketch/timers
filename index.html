<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PowerTimer PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-meta" content="#007bff">
    <style>
        :root {
            --bg: #ffffff; --card: #f0f0f0; --text: #1a1a1a;
            --accent: #007bff; --danger: #ff4444; --success: #00c851;
            --border: #dddddd;
        }
        [data-theme="dark"] {
            --bg: #0d0d0d; --card: #1a1a1a; --text: #e0e0e0;
            --border: #333333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); 
            color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center;
        }
        .header-tools { width: 100%; max-width: 450px; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .setup-card {
            background: var(--card); padding: 20px; border-radius: 16px;
            width: 100%; max-width: 450px; margin-bottom: 20px; border: 1px solid var(--border);
        }
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        input {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 12px; border-radius: 8px; font-size: 16px;
        }
        .time-inputs { display: flex; gap: 8px; justify-content: center; }
        .time-inputs input { width: 70px; text-align: center; font-size: 18px; }
        
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-main { background: var(--accent); color: white; padding: 15px; width: 100%; margin-top: 15px; }
        .btn-theme { background: var(--card); color: var(--text); padding: 8px 12px; border: 1px solid var(--border); }
        .btn-quick { background: var(--border); color: var(--text); padding: 8px; font-size: 13px; flex: 1; }
        .quick-actions { display: flex; gap: 8px; margin-top: 15px; }

        #timers-list { width: 100%; max-width: 450px; }
        .timer-item {
            background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px;
            border-left: 5px solid var(--accent); position: relative;
        }
        .timer-item.alarm { border-left-color: var(--danger); animation: alarm-flash 0.5s infinite; }
        .timer-header { display: flex; justify-content: space-between; align-items: center; }
        .timer-label { font-size: 14px; opacity: 0.7; text-transform: uppercase; }
        .timer-clock { font-size: 38px; font-family: monospace; font-weight: 700; margin: 10px 0; }
        
        .timer-controls { display: flex; gap: 15px; }
        .icon-btn { background: none; color: var(--text); opacity: 0.6; padding: 5px; display: flex; }
        .icon-btn svg { width: 28px; height: 28px; fill: currentColor; }
        .stop-alarm-btn { background: var(--danger); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; display: none; }
        .timer-item.alarm .stop-alarm-btn { display: block; }

        @keyframes alarm-flash { 
            0% { background: var(--card); } 
            50% { background: #ff444444; } 
            100% { background: var(--card); } 
        }
    </style>
</head>
<body data-theme="dark">

    <div class="header-tools">
        <button class="btn-theme" onclick="toggleTheme()" id="theme-toggle">ðŸŒ™ Modo Oscuro</button>
    </div>

    <div class="setup-card">
        <div class="input-group">
            <input type="text" id="t-name" placeholder="Nombre (ej. Cocinar)">
            <div class="time-inputs">
                <input type="number" id="t-h" placeholder="00" min="0">
                <input type="number" id="t-m" placeholder="00" min="0" max="59">
                <input type="number" id="t-s" placeholder="00" min="0" max="59">
            </div>
        </div>
        <button class="btn-main" onclick="createNewTimer()">INICIAR TIMER</button>
        <div class="quick-actions">
            <button class="btn-quick" onclick="quickTimer(60, '1 Min')">1m</button>
            <button class="btn-quick" onclick="quickTimer(300, '5 Min')">5m</button>
            <button class="btn-quick" onclick="quickTimer(1500, 'Pomodoro')">25m</button>
        </div>
    </div>

    <div id="timers-list"></div>

    <script>
        let timers = JSON.parse(localStorage.getItem('pwa_timers_v3')) || [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- GestiÃ³n de Tema ---
        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            setTheme(target);
        }
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-toggle').innerText = theme === 'dark' ? 'â˜€ï¸ Modo Claro' : 'ðŸŒ™ Modo Oscuro';
            localStorage.setItem('pwa_theme', theme);
            document.getElementById('theme-meta').setAttribute('content', theme === 'dark' ? '#0d0d0d' : '#ffffff');
        }
        setTheme(localStorage.getItem('pwa_theme') || 'dark');

        // --- LÃ³gica de Timers ---
        function save() { localStorage.setItem('pwa_timers_v3', JSON.stringify(timers)); }

        function createNewTimer() {
            const name = document.getElementById('t-name').value || "Timer";
            const total = (parseInt(document.getElementById('t-h').value || 0) * 3600) + 
                          (parseInt(document.getElementById('t-m').value || 0) * 60) + 
                          (parseInt(document.getElementById('t-s').value || 0));
            if(total > 0) addTimer(total, name);
        }

        function quickTimer(sec, name) { addTimer(sec, name); }

        function addTimer(seconds, name) {
            timers.push({ id: Date.now(), name, total: seconds, remaining: seconds, running: true, lastUpdate: Date.now(), finished: false });
            save(); render();
            document.querySelectorAll('.input-group input').forEach(i => i.value = '');
        }

        function playSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'triangle'; osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        function update() {
            const now = Date.now();
            let changed = false;
            timers.forEach(t => {
                if (t.running && t.remaining > 0) {
                    const delta = Math.floor((now - t.lastUpdate) / 1000);
                    if (delta >= 1) {
                        t.remaining = Math.max(0, t.remaining - delta);
                        t.lastUpdate = now;
                        if (t.remaining === 0) { t.running = false; t.finished = true; notify(t.name); }
                        changed = true;
                    }
                }
            });
            if (changed) { save(); render(); }
            if (timers.some(t => t.finished)) playSound();
        }

        function notify(name) {
            if (Notification.permission === "granted") new Notification("Â¡Tiempo agotado!", { body: `FinalizÃ³: ${name}` });
        }

        function stopAlarm(id) {
            const t = timers.find(t => t.id === id);
            if (t) { t.finished = false; save(); render(); }
        }

        function remove(id) { timers = timers.filter(t => t.id !== id); save(); render(); }

        function format(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${h>0?h+':':''}${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function render() {
            const container = document.getElementById('timers-list');
            container.innerHTML = timers.map(t => `
                <div class="timer-item ${t.finished ? 'alarm' : ''}">
                    <div class="timer-header">
                        <span class="timer-label">${t.name}</span>
                        <button class="icon-btn" onclick="remove(${t.id})">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <div class="timer-clock">${format(t.remaining)}</div>
                    <button class="stop-alarm-btn" onclick="stopAlarm(${t.id})">DETENER ALARMA</button>
                </div>
            `).join('');
        }

        setInterval(update, 1000);
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        if ("Notification" in window) Notification.requestPermission();
        render();
    </script>
</body>
</html>