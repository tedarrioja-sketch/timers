let timers = JSON.parse(localStorage.getItem('pwa_timers_v5')) || [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        }
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-toggle').innerText = theme === 'dark' ? 'â˜€ï¸ Modo Claro' : 'ðŸŒ™ Modo Oscuro';
            localStorage.setItem('pwa_theme', theme);
            document.getElementById('theme-meta').setAttribute('content', theme === 'dark' ? '#0d0d0d' : '#ffffff');
        }
        setTheme(localStorage.getItem('pwa_theme') || 'dark');

        function save() { localStorage.setItem('pwa_timers_v5', JSON.stringify(timers)); }

        function createNewTimer() {
            const name = document.getElementById('t-name').value || "Timer";
            const h = parseInt(document.getElementById('t-h').value || 0);
            const m = parseInt(document.getElementById('t-m').value || 0);
            const s = parseInt(document.getElementById('t-s').value || 0);
            const total = (h * 3600) + (m * 60) + s;
            if(total > 0) addTimer(total, name);
        }

        function quickTimer(sec, name) { addTimer(sec, name); }

        function addTimer(seconds, name) {
            timers.push({ 
                id: Date.now(), 
                name: name, 
                total: seconds, 
                remaining: seconds, 
                running: true, 
                lastUpdate: Date.now(), 
                isAlarming: false 
            });
            save(); render();
            document.querySelectorAll('.input-group input').forEach(i => i.value = '');
        }

        function playSound() {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine';
            o.frequency.setValueAtTime(587.33, audioCtx.currentTime); // Nota Re5
            o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            o.start(); o.stop(audioCtx.currentTime + 0.3);
        }

        function update() {
            const now = Date.now();
            let changed = false;
            let activeAlarms = false;

            timers.forEach(t => {
                if (t.running && !t.isAlarming) {
                    const delta = Math.floor((now - t.lastUpdate) / 1000);
                    if (delta >= 1) {
                        t.remaining -= delta;
                        t.lastUpdate = now;
                        
                        if (t.remaining <= 0) {
                            t.remaining = t.total; // RECURSIVIDAD: Reinicia el tiempo
                            t.isAlarming = true;   // Activa modo alarma
                            notify(t.name);
                        }
                        changed = true;
                    }
                }
                if (t.isAlarming) activeAlarms = true;
            });

            if (changed) { save(); render(); }
            if (activeAlarms) playSound();
        }

        function notify(name) {
            if (Notification.permission === "granted") {
                new Notification("Â¡Timer Recurrente!", { 
                    body: `El ciclo de "${name}" ha terminado. Sigue activo.`,
                    icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23ff4444%22/></svg>"
                });
            }
        }

        function stopAndPause(id) {
            const t = timers.find(t => t.id === id);
            if (t) {
                t.isAlarming = false;
                t.running = false; // Detiene el timer completamente
                save(); render();
            }
        }

        function toggleResume(id) {
            const t = timers.find(t => t.id === id);
            if (t) {
                t.running = !t.running;
                t.lastUpdate = Date.now();
                save(); render();
            }
        }

        function remove(id) {
            timers = timers.filter(t => t.id !== id);
            save(); render();
        }

        function format(s) {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
            return `${h>0?h+':':''}${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function render() {
            const container = document.getElementById('timers-list');
            container.innerHTML = timers.map(t => `
                <div class="timer-item ${t.isAlarming ? 'alarm' : ''}">
                    <div class="timer-header">
                        <strong>${t.name}</strong>
                        <button onclick="remove(${t.id})" style="background:none;color:var(--danger);font-size:20px">âœ•</button>
                    </div>
                    <div class="timer-clock">${format(t.remaining)}</div>
                    <div style="display:flex; gap:10px;">
                        ${t.isAlarming ? 
                            `<button class="stop-alarm-btn" style="display:block" onclick="stopAndPause(${t.id})">DETENER Y PAUSAR</button>` :
                            `<button class="btn-quick" onclick="toggleResume(${t.id})">
                                ${t.running ? 'PAUSAR' : 'REANUDAR'}
                            </button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        setInterval(update, 1000);
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
        render();
