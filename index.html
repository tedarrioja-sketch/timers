<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PowerTimer Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-meta" content="#0d0d0d">
    <style>
        :root { --bg: #ffffff; --card: #f2f2f2; --text: #1a1a1a; --accent: #007bff; --danger: #ff4444; --border: #dddddd; }
        [data-theme="dark"] { --bg: #0d0d0d; --card: #1a1a1a; --text: #e0e0e0; --border: #333333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; width: 100%; max-width: 450px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        h3 { margin-top: 0; font-weight: 600; font-size: 14px; text-transform: uppercase; opacity: 0.7; }
        input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 10px; }
        
        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .time-grid input { text-align: center; margin-bottom: 0; }
        
        .presets-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .preset-btn { background: var(--border); color: var(--text); border: none; padding: 8px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-main { background: var(--accent); color: white; padding: 15px; width: 100%; font-size: 16px; }
        .btn-secondary { background: var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; font-size: 12px; }

        .timer-item { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--accent); width: 100%; max-width: 450px; }
        .timer-item.alarm { border-left-color: var(--danger); animation: pulse 0.8s infinite; }
        .timer-clock { font-size: 48px; font-family: monospace; font-weight: 700; margin: 10px 0; text-align: center; color: var(--accent); }
        .timer-item.alarm .timer-clock { color: var(--danger); }
        
        .controls { display: flex; gap: 10px; }
        .stop-btn { background: var(--danger); color: white; padding: 15px; width: 100%; flex: 2; }
        
        @keyframes pulse { 0% { background: var(--card); } 50% { background: #ff444422; } 100% { background: var(--card); } }
    </style>
</head>
<body data-theme="dark">

    <div class="header">
        <h2 style="margin:0">PowerTimer Pro</h2>
        <button class="btn-secondary" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è CLARO</button>
    </div>

    <div class="card">
        <h3>Nuevo Timer Recurrente</h3>
        <input type="text" id="t-name" placeholder="Nombre (ej. Serie Gym)">
        <div class="time-grid">
            <input type="number" id="t-h" placeholder="HH">
            <input type="number" id="t-m" placeholder="MM">
            <input type="number" id="t-s" placeholder="SS">
        </div>
        
        <h3 style="margin-top:20px">Tus Ajustes Predefinidos</h3>
        <div id="presets-list" class="presets-container"></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn-main" onclick="startNewTimer()">INICIAR</button>
            <button class="btn-secondary" onclick="saveAsPreset()" title="Guardar como predefinido">üíæ</button>
        </div>
    </div>

    <div id="timers-list" style="width:100%; max-width:450px;"></div>

    <script>
        let timers = JSON.parse(localStorage.getItem('timers_v8')) || [];
        let presets = JSON.parse(localStorage.getItem('presets_v8')) || [
            { name: 'Pomodoro', h: 0, m: 25, s: 0 },
            { name: 'Descanso', h: 0, m: 5, s: 0 }
        ];
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // TEMA
        function toggleTheme() {
            const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', t);
            document.getElementById('theme-btn').innerText = t === 'dark' ? '‚òÄÔ∏è CLARO' : 'üåô OSCURO';
            localStorage.setItem('theme', t);
        }
        if(localStorage.getItem('theme')) document.body.setAttribute('data-theme', localStorage.getItem('theme'));

        // PRESETS
        function renderPresets() {
            const container = document.getElementById('presets-list');
            container.innerHTML = presets.map((p, i) => `
                <button class="preset-btn" onclick="applyPreset(${i})">${p.name} (${p.m}m)</button>
            `).join('');
        }

        function applyPreset(index) {
            const p = presets[index];
            document.getElementById('t-name').value = p.name;
            document.getElementById('t-h').value = p.h;
            document.getElementById('t-m').value = p.m;
            document.getElementById('t-s').value = p.s;
        }

        function saveAsPreset() {
            const name = document.getElementById('t-name').value || "Preset";
            const h = parseInt(document.getElementById('t-h').value || 0);
            const m = parseInt(document.getElementById('t-m').value || 0);
            const s = parseInt(document.getElementById('t-s').value || 0);
            if(h+m+s > 0) {
                presets.push({ name, h, m, s });
                localStorage.setItem('presets_v8', JSON.stringify(presets));
                renderPresets();
            }
        }

        // L√ìGICA TIMER
        function startNewTimer() {
            const name = document.getElementById('t-name').value || "Timer";
            const h = parseInt(document.getElementById('t-h').value || 0), m = parseInt(document.getElementById('t-m').value || 0), s = parseInt(document.getElementById('t-s').value || 0);
            const total = (h * 3600) + (m * 60) + s;
            if(total > 0) {
                timers.push({ id: Date.now(), name, total, remaining: total, running: true, lastUpdate: Date.now(), isAlarming: false });
                saveAndRender();
            }
        }

        function saveAndRender() {
            localStorage.setItem('timers_v8', JSON.stringify(timers));
            renderTimers();
        }

        function playBeep() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'square'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            o.start(); o.stop(audioCtx.currentTime + 0.15);
        }

        function update() {
            const now = Date.now();
            let alarm = false;
            timers.forEach(t => {
                if (t.running && !t.isAlarming) {
                    const d = Math.floor((now - t.lastUpdate) / 1000);
                    if (d >= 1) {
                        t.remaining -= d;
                        t.lastUpdate = now;
                        if (t.remaining <= 0) {
                            t.remaining = t.total; // RECURRENCIA AUTOM√ÅTICA
                            t.isAlarming = true;
                        }
                        saveAndRender();
                    }
                }
                if (t.isAlarming) alarm = true;
            });
            if (alarm) playBeep();
        }

        function stopTimer(id) {
            const t = timers.find(x => x.id === id);
            if(t) { t.isAlarming = false; t.running = false; saveAndRender(); }
        }

        function removeTimer(id) {
            timers = timers.filter(x => x.id !== id);
            saveAndRender();
        }

        function format(s) {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sc = s%60;
            return `${h>0?h+':':''}${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
        }

        function renderTimers() {
            document.getElementById('timers-list').innerHTML = timers.map(t => `
                <div class="timer-item ${t.isAlarming?'alarm':''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>${t.name}</strong>
                        <button onclick="removeTimer(${t.id})" style="background:none; color:var(--danger); font-size:18px;">‚úï</button>
                    </div>
                    <div class="timer-clock">${format(t.remaining)}</div>
                    <div class="controls">
                        ${t.isAlarming ? 
                            `<button class="stop-btn" onclick="stopTimer(${t.id})">DETENER ALARMA</button>` : 
                            `<button style="width:100%; padding:12px; background:var(--border); color:var(--text);" onclick="togglePause(${t.id})">${t.running?'PAUSAR':'REANUDAR'}</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function togglePause(id) {
            const t = timers.find(x => x.id === id);
            if(t) { t.running = !t.running; t.lastUpdate = Date.now(); saveAndRender(); }
        }

        setInterval(update, 1000);
        renderPresets();
        renderTimers();
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
